---
name: Flask CI/CD with Docker Hub Complete
on:
  push:
    branches:
      - main
  workflow_dispatch: null
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install dependencies (Flask and pytest)
        run: >
          python -m pip install --upgrade pip

          # Note: requirements.txt must include 'Flask' and 'pytest'

          # Ensure any integration test dependencies (e.g., requests) are also included

          pip install -r requirements.txt
      - name: Run Pytest Unit Tests
        run: pytest

---
jobs:
  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    env:
      DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
      IMAGE_NAME: flask-new-mlop-app
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          registry: docker.io
      - name: Set up Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}
          tags: >
            type=sha,format=short,prefix=

            # Tag with 'latest' only for pushes to the main branch

            type=raw,value=latest,enable=${{ github.ref == format('refs/heads/{0}', 'main') }}
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          file: ./DockerFile
      - name: Set output image tag
        id: image_tag_output
        run: echo "IMAGE_TAG=${IMAGE_NAME}:${{ steps.meta.outputs.version }}" >>
          $GITHUB_OUTPUT

---
deploy-test:
  needs: build-and-push
  runs-on: ubuntu-latest
  env:
    DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
    IMAGE_NAME: ${{ needs.build-and-push.outputs.IMAGE_TAG }}
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Run Docker Container
      run: |+
        # Full image path: DOCKER_HUB_USERNAME/IMAGE_NAME:tag
        FULL_IMAGE_NAME="${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}"
        echo "Running container from image: $FULL_IMAGE_NAME"
        docker run -d \
          --name flask-app-test \
          -p 8080:5000 \
          $FULL_IMAGE_NAME
          
    - name: Wait for application to be ready
      uses: jakejarvis/wait-action@master
      with:
        time: 15s
    - name: Test Running Application Response
      run: >
        # Install 'curl' if not available (it usually is on ubuntu-latest)

        sudo apt-get update && sudo apt-get install -y curl


        # Use curl to check the container's health/response on the mapped port

        # The exit code (0 for success, >0 for failure) determines job success/failure.

        STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/)


        echo "Received HTTP Status Code: $STATUS_CODE"


        if [ "$STATUS_CODE" -ne 200 ]; then
          echo "Integration test failed! Application did not return a 200 OK status."
          exit 1
        else
          echo "Integration test passed! Application returned a 200 OK status."
        fi
