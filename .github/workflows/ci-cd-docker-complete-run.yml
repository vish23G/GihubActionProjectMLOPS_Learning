name: Flask CI/CD with Docker Hub Complete RUN

# Triggers on push to the main branch or manual run
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  # -----------------------------------------------------------------
  # 1. TEST Job: Runs unit tests (Pytest)
  # -----------------------------------------------------------------
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies (Flask and pytest)
        # Note: requirements.txt must include 'Flask' and 'pytest'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest # Ensure pytest is available

      - name: Run Pytest Unit Tests
        run: pytest

  # -----------------------------------------------------------------
  # 2. BUILD and PUSH Job: Builds Docker image and pushes to Docker Hub
  # -----------------------------------------------------------------
  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    
    # Define outputs to pass the generated image tag to subsequent jobs
    outputs:
      image_full_tag: ${{ steps.image_tag_output.outputs.IMAGE_TAG }}

    env:
      DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
      IMAGE_NAME: flask-new-mlop-app

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          registry: docker.io

      - name: Set up Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,format=short,prefix=
            # Tag with 'latest' only for pushes to the main branch
            type=raw,value=latest,enable=${{ github.ref == format('refs/heads/{0}', 'main') }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          file: ./DockerFile
      
      - name: Set output image tag
        # This step sets the job output to the image tag generated by the short SHA
        id: image_tag_output
        run: |
          # Get the short SHA
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          # Set the output variable (e.g., flask-new-mlop-app:c90d79b)
          echo "IMAGE_TAG=${{ env.IMAGE_NAME }}:${SHORT_SHA}" >> $GITHUB_OUTPUT


  # -----------------------------------------------------------------
  # 3. DEPLOY-TEST Job: Pulls image, runs container, and performs a health check
  # -----------------------------------------------------------------
  deploy-test:
    needs: build-and-push
    runs-on: ubuntu-latest
    env:
      DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
      
    steps:
      - name: Run Docker Container
        run: |+
          # Retrieve the full image name and tag from the build-and-push job outputs
          IMAGE_FULL_TAG="${{ needs.build-and-push.outputs.image_full_tag }}"
          FULL_IMAGE_NAME="${{ env.DOCKER_HUB_USERNAME }}/$IMAGE_FULL_TAG"
          
          echo "Running container from image: $FULL_IMAGE_NAME"
          
          # Pull the image explicitly before running it
          docker pull $FULL_IMAGE_NAME
          
          docker run -d \
            --name flask-app-test \
            -p 8080:5000 \
            "$FULL_IMAGE_NAME"
          
      - name: Wait for application to be ready
        uses: jakejarvis/wait-action@master
        with:
          time: 15s

      - name: Test Running Application Response
        run: |
          # Install 'curl' for health check
          sudo apt-get update && sudo apt-get install -y curl

          # Use curl to check the container's health/response on the mapped port
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/)

          echo "Received HTTP Status Code: $STATUS_CODE"

          if [ "$STATUS_CODE" -ne 200 ]; then
            echo "Integration test failed! Application did not return a 200 OK status."
            exit 1
          else
            echo "Integration test passed! Application returned a 200 OK status."
          fi

          # Optional cleanup: Stop and remove the test container
          docker stop flask-app-test
          docker rm flask-app-test
